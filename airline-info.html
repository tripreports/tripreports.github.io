<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airline Info - Planespotting</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/png" id="favicon">
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        main {
            flex: 1;
            padding: 2rem 0;
        }

        .info-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .search-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            transition: border-color 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #2C5F8D;
        }

        .random-btn {
            padding: 0.75rem 1.5rem;
            background: #2C5F8D;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .random-btn:hover {
            background: #1e4666;
        }

        .filter-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.95rem;
            color: #495057;
            font-weight: 500;
        }

        .filter-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .filter-group select {
            padding: 0.5rem 0.75rem;
            font-size: 0.95rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            background: white;
        }

        .results-count {
            color: #6c757d;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .airline-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .airline-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .airline-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .airline-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .airline-tail {
            width: 60px;
            height: 45px;
            object-fit: contain;
            flex-shrink: 0;
            transform: rotate(-2deg);
        }

        .country-flag {
            width: 24px;
            height: 18px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 2px;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        .detail-country-flag {
            width: 32px;
            height: 24px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        .airline-card h3 {
            color: #2C5F8D;
            margin: 0;
            font-size: 1.25rem;
            flex: 1;
        }

        .airline-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .airline-detail:last-child {
            margin-bottom: 0;
        }

        .airline-detail .label {
            font-weight: 600;
            color: #495057;
        }

        .airline-detail .value {
            color: #6c757d;
        }

        .no-results {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        /* Detail view styles */
        .detail-view {
            display: none;
        }

        .detail-view.active {
            display: block;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #2C5F8D;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            margin-bottom: 2rem;
            transition: background 0.2s;
        }

        .back-button:hover {
            background: #1e4666;
        }

        .airline-detail-header {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .airline-detail-header h1 {
            color: #2C5F8D;
            margin: 0 0 1.5rem 0;
        }

        .airline-header-content {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 2rem;
            align-items: center;
        }

        .airline-info-section {
            display: flex;
            flex-direction: column;
        }

        .airline-info-table {
            width: 100%;
            border-collapse: collapse;
        }

        .airline-info-table td {
            padding: 0.5rem 0;
            vertical-align: top;
        }

        .airline-info-table .label {
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
        }

        .airline-info-table .value {
            color: #6c757d;
        }

        .detail-tail-display {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 150px;
            height: 150px;
            margin-right: 10rem;
        }

        .detail-tail-display img {
            max-width: 150px;
            max-height: 150px;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .detail-logo-display {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 200px;
            height: 150px;
        }

        .detail-logo-display img {
            max-width: 190px;
            max-height: 140px;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .airline-preview {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .airline-preview h2 {
            color: #2C5F8D;
            margin: 0 0 1.5rem 0;
        }

        .plane-preview-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
        }

        .plane-preview {
            position: relative;
            width: 600px;
            height: auto;
            max-width: 100%;
        }

        .plane-preview img.plane-base {
            width: 600px;
            max-width: 100%;
            height: auto;
            display: block;
        }

        .plane-preview .overlay-tail {
            position: absolute;
            top: -20px;
            left: 1px;
            width: 145px;
            height: auto;
            transform: rotate(-1deg);
        }

        @media (max-width: 768px) {
            .plane-preview {
                width: 400px;
                height: auto;
            }

            .plane-preview img.plane-base {
                width: 400px;
            }

            .plane-preview .overlay-tail {
                top: -21.33px;
                left: -17.33px;
                width: 100px;
                transform: rotate(-2deg);
            }

            .airline-header-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .detail-tail-display,
            .detail-logo-display {
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <nav class="filter-nav">
        <div class="container">
            <h1 class="site-title"><a href="index.html" style="color: white; text-decoration: none;">Planespotting</a></h1>
            <div class="filter-buttons">
                <a href="index.html" class="filter-btn">Go Home</a>
                <a href="planespotting.html" class="filter-btn">Go Planespotting</a>
                <a href="airline-info.html" class="filter-btn active">Airline Info</a>
                <a href="aircraft-info.html" class="filter-btn">Aircraft Info</a>
            </div>
        </div>
    </nav>

    <main>
        <div class="info-container">
            <!-- List View -->
            <div id="list-view">
                <div class="search-controls">
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="Search by airline name, IATA code, or country...">
                    </div>
                    <button class="random-btn" id="random-btn">Random Airline</button>
                </div>

                <div class="filter-controls">
                    <div class="filter-group">
                        <input type="checkbox" id="filter-has-tail" checked>
                        <label for="filter-has-tail">Only airlines with tail images</label>
                    </div>
                    <div class="filter-group">
                        <label for="results-limit">Show:</label>
                        <select id="results-limit">
                            <option value="20">20 results</option>
                            <option value="50">50 results</option>
                            <option value="100">100 results</option>
                            <option value="9999">All results</option>
                        </select>
                    </div>
                </div>

                <div class="results-count" id="results-count"></div>

                <div class="airline-grid" id="airline-grid">
                    <div class="no-results">Loading airlines...</div>
                </div>
            </div>

            <!-- Detail View -->
            <div id="detail-view" class="detail-view">
                <button class="back-button" id="back-btn">← Back to Search</button>

                <div class="airline-detail-header">
                    <h1 id="detail-airline-name"></h1>
                    <div class="airline-header-content">
                        <div class="airline-info-section">
                            <table class="airline-info-table">
                                <tr>
                                    <td class="label">IATA Code:</td>
                                    <td class="value" id="detail-iata"></td>
                                </tr>
                                <tr>
                                    <td class="label">ICAO Code:</td>
                                    <td class="value" id="detail-icao"></td>
                                </tr>
                                <tr>
                                    <td class="label">Call Sign:</td>
                                    <td class="value" id="detail-callsign"></td>
                                </tr>
                                <tr>
                                    <td class="label">Country:</td>
                                    <td class="value" id="detail-country"></td>
                                </tr>
                            </table>
                        </div>
                        <div class="detail-tail-display">
                            <img id="detail-tail-image" alt="Airline tail">
                        </div>
                        <div class="detail-logo-display">
                            <img id="detail-logo" alt="Airline logo">
                        </div>
                    </div>
                </div>

                <div class="airline-preview">
                    <h2>Aircraft Preview</h2>
                    <div class="plane-preview-container">
                        <div class="plane-preview">
                            <img src="images/icons/plane_right.png" alt="Aircraft" class="plane-base">
                            <img id="detail-tail-overlay" class="overlay-tail" alt="Airline tail">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // All tail images (ICAO codes + remaining IATA codes without ICAO equivalents)
        const tailImages = [
            '4Y', '8R', 'AAF', 'AAL', 'AAR', 'AAT', 'AB', 'ABJ', 'ABL', 'ABY', 'ACA', 'ACI',
            'ADM', 'ADR', 'AEA', 'AEE', 'AES', 'AFB', 'AFF', 'AFL', 'AFR', 'AGX', 'AIB', 'AIC',
            'AIQ', 'AIZ', 'AJX', 'AL', 'ALK', 'AMC', 'AMX', 'ANA', 'ANE', 'ANZ', 'APW', 'ARG',
            'ASA', 'ASL', 'AU', 'AUA', 'AUI', 'AUT', 'AVA', 'AVN', 'AWE', 'AWQ', 'AXM', 'AZA',
            'AZU', 'B0', 'BAV', 'BAW', 'BCY', 'BEE', 'BER', 'BF', 'BKP', 'BLF', 'BMI', 'BOI',
            'BON', 'BOV', 'BRU', 'BTI', 'BTK', 'BXI', 'BZH', 'CAL', 'CAW', 'CCA', 'CCM', 'CEB',
            'CES', 'CFE', 'CFG', 'CHH', 'CIX', 'CLH', 'CMP', 'CPA', 'CRK', 'CRL', 'CSA', 'CSC',
            'CSH', 'CSN', 'CSZ', 'CTN', 'CWC', 'CXA', 'DAH', 'DAL', 'DDL', 'DJ', 'DLA', 'DLH',
            'E9', 'EAQ', 'EDW', 'EGF', 'EIA', 'EIN', 'EJU', 'ELY', 'ENY', 'ETD', 'ETH', 'EVA',
            'EWG', 'EXS', 'EZD', 'EZE', 'FAJ', 'FDB', 'FFM', 'FFT', 'FIF', 'FIN', 'FLA', 'FLE',
            'FLI', 'FOS', 'FWI', 'GFA', 'GIA', 'GLO', 'GUY', 'HAL', 'HDA', 'HRH', 'HVN', 'IAD',
            'IBB', 'IBE', 'IBS', 'ICE', 'IGO', 'IRA', 'IRC', 'IRM', 'ITY', 'JAF', 'JAI', 'JAL',
            'JAT', 'JBU', 'JEC', 'JGO', 'JJP', 'JSA', 'JST', 'JW', 'KAC', 'KAL', 'KFR', 'KLA',
            'KLC', 'KLM', 'KQA', 'LAN', 'LAO', 'LBC', 'LBT', 'LGL', 'LH', 'LNI', 'LNK', 'LOG',
            'LOT', 'LPE', 'LPV', 'LVG', 'LZB', 'MAC', 'MAS', 'MAU', 'MDA', 'MDG', 'MEA', 'MHS',
            'MLT', 'MSR', 'MXD', 'NBT', 'NOK', 'NOZ', 'NTW', 'OAL', 'OAW', 'OF', 'OMA', 'ONE',
            'PAL', 'PD', 'PGA', 'PGT', 'PIC', 'PRZ', 'PSD', 'QFA', 'QG', 'QSC', 'QTR', 'RAM',
            'RCK', 'REU', 'RJA', 'ROT', 'ROU', 'RSL', 'RSR', 'RWD', 'RYR', 'RZO', 'S5', 'SAA',
            'SAS', 'SCW', 'SDG', 'SEJ', 'SEY', 'SFJ', 'SFR', 'SIA', 'SJX', 'SKU', 'SLK', 'SNG',
            'SUS', 'SVA', 'SWA', 'SWR', 'SYX', 'TAM', 'TAP', 'TAR', 'TGW', 'THA', 'THT', 'THY',
            'TJT', 'TLM', 'TNA', 'TOM', 'TSC', 'TT', 'TTW', 'TUA', 'TUX', 'TVF', 'TVS', 'TWN',
            'UAE', 'UAL', 'UIA', 'US', 'UZB', 'VAW', 'VIR', 'VJC', 'VLG', 'VOE', 'VOZ', 'VTA',
            'VTI', 'WAJ', 'WEN', 'WIF', 'WJA', 'WOW', 'WW', 'WZZ', 'XAX', 'XLA', 'XZ'
        ];
        const randomTail = tailImages[Math.floor(Math.random() * tailImages.length)];
        document.getElementById('favicon').href = `images/tails/${randomTail}.png`;

        // Airline data and functionality
        let allAirlines = [];
        let filteredAirlines = [];
        let iataToIcaoMapping = null;
        let resultsLimit = 20;
        let filterHasTail = true;

        // Load IATA to ICAO mapping
        async function loadIataToIcaoMapping() {
            try {
                const response = await fetch('data/iata_to_icao_mapping.json');
                if (response.ok) {
                    iataToIcaoMapping = await response.json();
                }
            } catch (error) {
                console.error('Error loading IATA to ICAO mapping:', error);
            }
        }

        // Convert IATA code to ICAO code (or return as-is if no mapping exists)
        function getIcaoCode(iataCode) {
            if (!iataCode) return null;

            // If mapping is loaded and code exists in mapping, use ICAO
            if (iataToIcaoMapping && iataToIcaoMapping[iataCode]) {
                return iataToIcaoMapping[iataCode];
            }

            // Otherwise, return the code as-is (might already be ICAO or an IATA without ICAO equivalent)
            return iataCode;
        }

        // Load airline data
        async function loadAirlines() {
            try {
                const response = await fetch('data/airlines.json');
                allAirlines = await response.json();

                // Apply initial filter
                if (filterHasTail) {
                    filteredAirlines = allAirlines.filter(airline => hasTailImage(airline));
                } else {
                    filteredAirlines = allAirlines;
                }

                // Only render if we're showing list view (not detail view)
                const urlParams = new URLSearchParams(window.location.search);
                if (!urlParams.get('code')) {
                    renderAirlines(filteredAirlines);
                }
            } catch (error) {
                console.error('Error loading airlines:', error);
                document.getElementById('airline-grid').innerHTML = '<div class="no-results">Error loading airline data</div>';
            }
        }

        // Check if airline has a tail image available
        function hasTailImage(airline) {
            const iataCode = airline.IATA;
            const icaoCode = airline.ICAO;

            if (!iataCode && !icaoCode) return false;

            // Convert IATA to ICAO if possible
            const convertedIcao = getIcaoCode(iataCode);

            // Check if we have the ICAO version
            if (convertedIcao && tailImages.includes(convertedIcao)) {
                return true;
            }

            // Check if we have the IATA version
            if (iataCode && tailImages.includes(iataCode)) {
                return true;
            }

            // Check if we have the ICAO code
            if (icaoCode && tailImages.includes(icaoCode)) {
                return true;
            }

            return false;
        }

        // Get tail image path - converts IATA to ICAO first and checks if we have the image
        function getTailImagePath(airlineCode) {
            if (!airlineCode) return 'images/tails/unknown.png';

            // Convert to ICAO if possible
            const icaoCode = getIcaoCode(airlineCode);

            // Check if we have this tail image
            if (tailImages.includes(icaoCode)) {
                return `images/tails/${icaoCode}.png`;
            }

            // If we don't have the ICAO version, check if we have the original IATA code
            if (airlineCode !== icaoCode && tailImages.includes(airlineCode)) {
                return `images/tails/${airlineCode}.png`;
            }

            // We don't have this tail image, use unknown
            return 'images/tails/unknown.png';
        }

        // Country name to ISO2 code mapping for flags
        const countryToISO2 = {
            'United States': 'us', 'United Kingdom': 'gb', 'Canada': 'ca', 'Australia': 'au',
            'Germany': 'de', 'France': 'fr', 'Italy': 'it', 'Spain': 'es', 'Netherlands': 'nl',
            'Belgium': 'be', 'Switzerland': 'ch', 'Austria': 'at', 'Sweden': 'se', 'Norway': 'no',
            'Denmark': 'dk', 'Finland': 'fi', 'Ireland': 'ie', 'Portugal': 'pt', 'Greece': 'gr',
            'Poland': 'pl', 'Czech Republic': 'cz', 'Hungary': 'hu', 'Romania': 'ro', 'Bulgaria': 'bg',
            'Croatia': 'hr', 'Serbia': 'rs', 'Slovenia': 'si', 'Slovakia': 'sk', 'Lithuania': 'lt',
            'Latvia': 'lv', 'Estonia': 'ee', 'Iceland': 'is', 'Luxembourg': 'lu', 'Malta': 'mt',
            'Cyprus': 'cy', 'Turkey': 'tr', 'Russia': 'ru', 'Ukraine': 'ua', 'Belarus': 'by',
            'China': 'cn', 'Japan': 'jp', 'South Korea': 'kr', 'India': 'in', 'Thailand': 'th',
            'Vietnam': 'vn', 'Singapore': 'sg', 'Malaysia': 'my', 'Indonesia': 'id', 'Philippines': 'ph',
            'Taiwan': 'tw', 'Hong Kong': 'hk', 'New Zealand': 'nz', 'South Africa': 'za',
            'Egypt': 'eg', 'Morocco': 'ma', 'Kenya': 'ke', 'Nigeria': 'ng', 'Ethiopia': 'et',
            'Brazil': 'br', 'Argentina': 'ar', 'Chile': 'cl', 'Colombia': 'co', 'Peru': 'pe',
            'Mexico': 'mx', 'Venezuela': 've', 'Ecuador': 'ec', 'Uruguay': 'uy', 'Paraguay': 'py',
            'Saudi Arabia': 'sa', 'United Arab Emirates': 'ae', 'Qatar': 'qa', 'Kuwait': 'kw',
            'Oman': 'om', 'Bahrain': 'bh', 'Jordan': 'jo', 'Lebanon': 'lb', 'Israel': 'il',
            'Iran': 'ir', 'Iraq': 'iq', 'Pakistan': 'pk', 'Bangladesh': 'bd', 'Sri Lanka': 'lk',
            'Nepal': 'np', 'Afghanistan': 'af', 'Kazakhstan': 'kz', 'Uzbekistan': 'uz',
            'Azerbaijan': 'az', 'Georgia': 'ge', 'Armenia': 'am', 'Albania': 'al', 'Bosnia and Herzegovina': 'ba',
            'North Macedonia': 'mk', 'Montenegro': 'me', 'Kosovo': 'xk', 'Moldova': 'md',
            'Yemen': 'ye', 'Syria': 'sy', 'Tunisia': 'tn', 'Algeria': 'dz', 'Libya': 'ly',
            'Sudan': 'sd', 'Ghana': 'gh', 'Tanzania': 'tz', 'Uganda': 'ug', 'Angola': 'ao',
            'Mozambique': 'mz', 'Zimbabwe': 'zw', 'Zambia': 'zm', 'Botswana': 'bw', 'Namibia': 'na',
            'Mauritius': 'mu', 'Seychelles': 'sc', 'Madagascar': 'mg', 'Reunion': 're',
            'Bahamas': 'bs', 'Jamaica': 'jm', 'Trinidad and Tobago': 'tt', 'Barbados': 'bb',
            'Aruba': 'aw', 'Curacao': 'cw', 'Dominican Republic': 'do', 'Puerto Rico': 'pr',
            'Cuba': 'cu', 'Haiti': 'ht', 'Panama': 'pa', 'Costa Rica': 'cr', 'Nicaragua': 'ni',
            'Honduras': 'hn', 'El Salvador': 'sv', 'Guatemala': 'gt', 'Belize': 'bz',
            'Greenland': 'gl', 'Faroe Islands': 'fo', 'Liechtenstein': 'li', 'Monaco': 'mc',
            'Andorra': 'ad', 'San Marino': 'sm', 'Vatican City': 'va',
            'Maldives': 'mv', 'Cambodia': 'kh', 'Myanmar': 'mm', 'Laos': 'la', 'Mongolia': 'mn',
            'Brunei': 'bn', 'Fiji': 'fj', 'Papua New Guinea': 'pg', 'New Caledonia': 'nc',
            'French Polynesia': 'pf', 'Cook Islands': 'ck', 'Samoa': 'ws', 'Tonga': 'to',
            'Vanuatu': 'vu', 'Solomon Islands': 'sb', 'Palau': 'pw', 'Micronesia': 'fm',
            'Marshall Islands': 'mh', 'Kiribati': 'ki', 'Nauru': 'nr', 'Tuvalu': 'tv',
            'Antigua and Barbuda': 'ag', 'Saint Lucia': 'lc', 'Grenada': 'gd', 'Saint Vincent and the Grenadines': 'vc',
            'Saint Kitts and Nevis': 'kn', 'Dominica': 'dm', 'Cape Verde': 'cv',
            'Sao Tome and Principe': 'st', 'Comoros': 'km', 'Equatorial Guinea': 'gq',
            'Gabon': 'ga', 'Republic of the Congo': 'cg', 'Democratic Republic of the Congo': 'cd',
            'Rwanda': 'rw', 'Burundi': 'bi', 'Djibouti': 'dj', 'Eritrea': 'er', 'Somalia': 'so',
            'South Sudan': 'ss', 'Chad': 'td', 'Central African Republic': 'cf', 'Cameroon': 'cm',
            'Niger': 'ne', 'Mali': 'ml', 'Burkina Faso': 'bf', 'Senegal': 'sn', 'Guinea': 'gn',
            'Sierra Leone': 'sl', 'Liberia': 'lr', 'Ivory Coast': 'ci', 'Benin': 'bj', 'Togo': 'tg',
            'Gambia': 'gm', 'Guinea-Bissau': 'gw', 'Mauritania': 'mr', 'Western Sahara': 'eh',
            'Turkmenistan': 'tm', 'Tajikistan': 'tj', 'Kyrgyzstan': 'kg', 'Bhutan': 'bt',
            'Timor-Leste': 'tl', 'East Timor': 'tl'
        };

        // Get country flag URL
        function getFlagUrl(countryName) {
            if (!countryName) return null;
            const iso2 = countryToISO2[countryName];
            if (!iso2) return null;
            return `https://flagcdn.com/w40/${iso2}.png`;
        }

        // Parse multiple countries from a string
        function parseCountries(countryString) {
            if (!countryString) return [];
            // Split by common separators: /, comma, and, &
            const countries = countryString.split(/[\/,&]|\sand\s/i)
                .map(c => c.trim())
                .filter(c => c.length > 0);
            return countries;
        }

        // Get all flag URLs for a country string
        function getFlagUrls(countryString) {
            const countries = parseCountries(countryString);
            return countries.map(country => ({
                country: country,
                url: getFlagUrl(country)
            })).filter(f => f.url !== null);
        }

        // Create flags HTML
        function createFlagsHtml(countryString, className = 'country-flag') {
            const flags = getFlagUrls(countryString);
            if (flags.length === 0) return '';
            return flags.map(flag =>
                `<img src="${flag.url}" alt="${flag.country}" title="${flag.country}" class="${className}">`
            ).join('');
        }

        // Create airline card HTML
        function createAirlineCard(airline) {
            const iataCode = airline.IATA;
            const tailPath = getTailImagePath(iataCode);
            const tailAlt = iataCode || 'Unknown';
            const cardId = `card-${Math.random().toString(36).substr(2, 9)}`;
            const countryFlags = createFlagsHtml(airline['Country/Region']);

            return `
                <a href="?code=${encodeURIComponent(iataCode || airline.ICAO || '')}" class="airline-card">
                    <div class="airline-header">
                        <img src="${tailPath}" alt="${tailAlt}" class="airline-tail" data-iata="${iataCode || ''}" data-card-id="${cardId}">
                        <h3>${airline.Airline || 'Unknown'}</h3>
                    </div>
                    <div class="airline-detail">
                        <span class="label">IATA Code:</span>
                        <span class="value">${airline.IATA || 'N/A'}</span>
                    </div>
                    <div class="airline-detail">
                        <span class="label">ICAO Code:</span>
                        <span class="value">${airline.ICAO || 'N/A'}</span>
                    </div>
                    <div class="airline-detail">
                        <span class="label">Call Sign:</span>
                        <span class="value">${airline['Call sign'] || 'N/A'}</span>
                    </div>
                    <div class="airline-detail">
                        <span class="label">Country:</span>
                        <span class="value">${countryFlags}${airline['Country/Region'] || 'N/A'}</span>
                    </div>
                </a>
            `;
        }

        // Render airlines
        function renderAirlines(airlines) {
            const grid = document.getElementById('airline-grid');
            const resultsCount = document.getElementById('results-count');

            if (airlines.length === 0) {
                grid.innerHTML = '<div class="no-results">No airlines found</div>';
                resultsCount.textContent = '';
                return;
            }

            // Apply limit
            const totalResults = airlines.length;
            const displayedAirlines = airlines.slice(0, resultsLimit);

            // Update count message
            if (totalResults > resultsLimit) {
                resultsCount.textContent = `Showing ${displayedAirlines.length} of ${totalResults} airline${totalResults === 1 ? '' : 's'}`;
            } else {
                resultsCount.textContent = `Showing ${totalResults} airline${totalResults === 1 ? '' : 's'}`;
            }

            grid.innerHTML = displayedAirlines.map(createAirlineCard).join('');

            // Add error handlers to tail images (should rarely trigger now since we pre-check)
            grid.querySelectorAll('.airline-tail').forEach(img => {
                img.onerror = function() {
                    this.onerror = null;
                    this.src = 'images/tails/unknown.png';
                };
            });
        }

        // Search functionality with prioritization
        function searchAirlines(query) {
            let results = [];

            if (!query.trim()) {
                results = allAirlines;
            } else {
                const searchTerm = query.toLowerCase();

                // Separate exact code matches from partial matches
                const exactMatches = allAirlines.filter(airline =>
                    airline.IATA?.toLowerCase() === searchTerm ||
                    airline.ICAO?.toLowerCase() === searchTerm
                );

                const partialMatches = allAirlines.filter(airline => {
                    // Skip if already in exact matches
                    if (airline.IATA?.toLowerCase() === searchTerm ||
                        airline.ICAO?.toLowerCase() === searchTerm) {
                        return false;
                    }
                    return (
                        (airline.Airline && airline.Airline.toLowerCase().includes(searchTerm)) ||
                        (airline.IATA && airline.IATA.toLowerCase().includes(searchTerm)) ||
                        (airline.ICAO && airline.ICAO.toLowerCase().includes(searchTerm)) ||
                        (airline['Country/Region'] && airline['Country/Region'].toLowerCase().includes(searchTerm)) ||
                        (airline['Call sign'] && airline['Call sign'].toLowerCase().includes(searchTerm))
                    );
                });

                // Prioritize exact matches first
                results = [...exactMatches, ...partialMatches];
            }

            // Apply tail filter if enabled
            if (filterHasTail) {
                results = results.filter(airline => hasTailImage(airline));
            }

            filteredAirlines = results;
            renderAirlines(filteredAirlines);
        }

        // Random airline
        function showRandomAirline() {
            if (allAirlines.length === 0) return;

            // Filter airlines based on current filter settings
            let availableAirlines = allAirlines;
            if (filterHasTail) {
                availableAirlines = allAirlines.filter(airline => hasTailImage(airline));
            }

            if (availableAirlines.length === 0) return;

            const randomAirline = availableAirlines[Math.floor(Math.random() * availableAirlines.length)];
            const code = randomAirline.IATA || randomAirline.ICAO || '';
            if (code) {
                window.location.href = `?code=${encodeURIComponent(code)}`;
            }
        }

        // Show detail view for an airline
        function showDetailView(code) {
            const airline = allAirlines.find(a =>
                a.IATA === code || a.ICAO === code
            );

            if (!airline) {
                window.location.href = 'airline-info.html';
                return;
            }

            // Populate detail view
            document.getElementById('detail-airline-name').textContent = airline.Airline || 'Unknown';
            document.getElementById('detail-iata').textContent = airline.IATA || 'N/A';
            document.getElementById('detail-icao').textContent = airline.ICAO || 'N/A';
            document.getElementById('detail-callsign').textContent = airline['Call sign'] || 'N/A';

            // Add flags to country field
            const countryFlags = createFlagsHtml(airline['Country/Region'], 'detail-country-flag');
            document.getElementById('detail-country').innerHTML = countryFlags + (airline['Country/Region'] || 'N/A');

            // Handle images
            const iataCode = airline.IATA;
            const icaoCode = airline.ICAO;
            const tailPath = getTailImagePath(iataCode);
            const detailTailImage = document.getElementById('detail-tail-image');
            const detailLogo = document.getElementById('detail-logo');
            const detailTailOverlay = document.getElementById('detail-tail-overlay');

            // Middle: Show tail image or unknown.png
            detailTailImage.src = tailPath;
            detailTailImage.onerror = function() {
                this.src = 'images/tails/unknown.png';
                this.onerror = null;
            };

            // Right: Show logo from avcodes.co.uk
            if (icaoCode) {
                detailLogo.style.display = 'block';
                detailLogo.src = `https://www.avcodes.co.uk/images/logos/${icaoCode}.png`;
                detailLogo.onerror = function() {
                    // Hide if logo not found
                    this.style.display = 'none';
                };
            } else {
                // No ICAO code, hide logo
                detailLogo.style.display = 'none';
            }

            // Show overlay tail only if image exists
            detailTailOverlay.style.display = 'block';
            detailTailOverlay.src = tailPath;
            detailTailOverlay.onerror = function() {
                // Hide the overlay if tail image doesn't exist
                this.style.display = 'none';
            };

            // Update back button text
            updateBackButtonText();

            // Toggle views
            document.getElementById('list-view').style.display = 'none';
            document.getElementById('detail-view').classList.add('active');
        }

        // Show list view
        function showListView() {
            document.getElementById('list-view').style.display = 'block';
            document.getElementById('detail-view').classList.remove('active');
        }

        // Check URL parameters on load
        function checkURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const airlineCode = urlParams.get('code');

            if (airlineCode && allAirlines.length > 0) {
                showDetailView(airlineCode);
            } else {
                showListView();
            }
        }

        // Event listeners
        document.getElementById('search-input').addEventListener('input', (e) => {
            searchAirlines(e.target.value);
        });

        document.getElementById('random-btn').addEventListener('click', showRandomAirline);

        // Filter controls
        document.getElementById('filter-has-tail').addEventListener('change', (e) => {
            filterHasTail = e.target.checked;
            // Re-apply current search
            searchAirlines(document.getElementById('search-input').value);
        });

        document.getElementById('results-limit').addEventListener('change', (e) => {
            resultsLimit = parseInt(e.target.value);
            // Re-render with new limit
            renderAirlines(filteredAirlines);
        });

        // Back button
        document.getElementById('back-btn').addEventListener('click', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const referrer = urlParams.get('ref');

            if (referrer === 'planespotting') {
                window.location.href = 'planespotting.html';
            } else {
                window.location.href = 'airline-info.html';
            }
        });

        // Update back button text based on referrer
        function updateBackButtonText() {
            const urlParams = new URLSearchParams(window.location.search);
            const referrer = urlParams.get('ref');
            const backBtn = document.getElementById('back-btn');

            if (referrer === 'planespotting') {
                backBtn.textContent = '← Back to Planespotting';
            } else {
                backBtn.textContent = '← Back to Search';
            }
        }

        // Initialize
        Promise.all([
            loadIataToIcaoMapping(),
            loadAirlines()
        ]).then(() => {
            checkURLParams();
        });
    </script>
</body>
</html>
